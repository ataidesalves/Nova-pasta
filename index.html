<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciamento de Dados por Data</title>

<!-- jsPDF + html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 30px;
    background: #fafafa;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  button {
    padding: 8px 14px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background: #007bff;
    color: white;
    transition: 0.2s;
  }
  button:hover {
    background: #0056b3;
  }
  input[type="month"] {
    padding: 6px;
    font-size: 14px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
    font-size: 13px;
  }
  th {
    background-color: #f0f0f0;
  }
  td[contenteditable="true"] {
    background: #fdfdfd;
    outline: none;
  }
  tfoot td {
    font-weight: bold;
    background: #f9f9f9;
  }
</style>
</head>
<body>

<h1>Gerenciamento de Dados por Data</h1>

<div class="controls">
  <label for="mes">Selecione o m√™s:</label>
  <input type="month" id="mes">
  <button id="gerar">üìÖ Gerar Tabela</button>
  <button id="inserirColuna">‚ûï Inserir Coluna</button>
  <button id="inserirColunaMoeda">üí∞ Inserir Coluna Moeda</button>
  <button id="excluirColuna">‚ûñ Excluir Coluna</button>
  <button id="salvarPDF">üßæ Salvar em PDF</button>
  <button id="limparDados" style="background:#dc3545;">üóëÔ∏è Limpar Dados</button>
</div>

<table id="tabela">
  <thead>
    <tr>
      <th>Data</th>
      <th>Dia da Semana</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot><tr></tr></tfoot>
</table>

<script>
const tabela = document.querySelector("#tabela tbody");
const tfoot = document.querySelector("#tabela tfoot tr");
const thead = document.querySelector("#tabela thead tr");
const inputMes = document.getElementById("mes");

// Bot√µes
const gerarBtn = document.getElementById("gerar");
const inserirColunaBtn = document.getElementById("inserirColuna");
const inserirColunaMoedaBtn = document.getElementById("inserirColunaMoeda");
const excluirColunaBtn = document.getElementById("excluirColuna");
const salvarPDFBtn = document.getElementById("salvarPDF");
const limparDadosBtn = document.getElementById("limparDados");

// ========== GERA TABELA ==========
function gerarTabela(mes) {
  tabela.innerHTML = "";
  const [ano, mesNum] = mes.split("-");
  const ultimoDia = new Date(ano, mesNum, 0).getDate();
  const numExtras = thead.querySelectorAll("th").length - 2;

  for (let dia = 1; dia <= ultimoDia; dia++) {
    const data = new Date(ano, mesNum - 1, dia);
    const diaSemana = data.toLocaleDateString("pt-BR", { weekday: "long" });

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.toLocaleDateString("pt-BR")}</td>
      <td>${diaSemana}</td>
    `;
    for (let i = 0; i < numExtras; i++) {
      const th = thead.querySelectorAll("th")[i + 2];
      const isMoeda = th.classList.contains("coluna-moeda");
      const td = document.createElement("td");
      td.contentEditable = "true";
      td.classList.add("data-cell");
      if (isMoeda) td.classList.add("moeda");
      tr.appendChild(td);
    }
    tabela.appendChild(tr);
  }
  atualizarRodape();
}

// ========== COLUNAS ==========
function adicionarColuna(nome, isMoeda = false) {
  const th = document.createElement("th");
  th.textContent = nome;
  if (isMoeda) th.classList.add("coluna-moeda");
  thead.appendChild(th);

  tabela.querySelectorAll("tr").forEach(tr => {
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.classList.add("data-cell");
    if (isMoeda) td.classList.add("moeda");
    tr.appendChild(td);
  });

  const tdFoot = document.createElement("td");
  tdFoot.textContent = isMoeda ? "R$ 0,00" : "";
  tfoot.appendChild(tdFoot);

  salvarEstrutura();
  salvarDados();
}

inserirColunaBtn.onclick = () => {
  const nome = prompt("Nome da nova coluna:");
  if (nome) adicionarColuna(nome, false);
};

inserirColunaMoedaBtn.onclick = () => {
  const nome = prompt("Nome da nova coluna de moeda:");
  if (nome) adicionarColuna(nome, true);
};

excluirColunaBtn.onclick = () => {
  const ths = thead.querySelectorAll("th");
  if (ths.length <= 2) return alert("N√£o h√° colunas adicionais para excluir!");
  const idx = ths.length - 1;
  ths[idx].remove();
  tabela.querySelectorAll("tr").forEach(tr => tr.children[idx].remove());
  if (tfoot.children[idx]) tfoot.children[idx].remove();
  salvarEstrutura();
  salvarDados();
};

// ========== SALVAR / RESTAURAR ==========
function salvarEstrutura() {
  const colunas = Array.from(thead.querySelectorAll("th"))
    .slice(2)
    .map(th => ({ nome: th.textContent, moeda: th.classList.contains("coluna-moeda") }));
  localStorage.setItem("colunasExtras", JSON.stringify(colunas));
}

function salvarDados() {
  const dados = [];
  tabela.querySelectorAll("tr").forEach(tr => {
    const linha = Array.from(tr.querySelectorAll(".data-cell")).map(td => td.textContent);
    dados.push(linha);
  });
  localStorage.setItem("dadosTabela", JSON.stringify(dados));
  localStorage.setItem("mesSelecionado", inputMes.value);
  atualizarRodape();
}

function restaurarEstrutura() {
  const colunas = JSON.parse(localStorage.getItem("colunasExtras")) || [];
  colunas.forEach(({ nome, moeda }) => adicionarColuna(nome, moeda));
}

function restaurarDados() {
  const dados = JSON.parse(localStorage.getItem("dadosTabela")) || [];
  const linhas = tabela.querySelectorAll("tr");
  dados.forEach((linha, i) => {
    const celulas = linhas[i]?.querySelectorAll(".data-cell");
    if (!celulas) return;
    linha.forEach((valor, j) => {
      if (celulas[j]) celulas[j].textContent = valor;
    });
  });
  atualizarRodape();
}

function restaurarTudo() {
  const mes = localStorage.getItem("mesSelecionado");
  if (mes) {
    inputMes.value = mes;
    gerarTabela(mes);
    restaurarEstrutura();
    restaurarDados();
  }
}

// ========== MOEDAS ==========
tabela.addEventListener("input", e => {
  if (e.target.classList.contains("moeda")) {
    let valor = e.target.textContent.replace(/\D/g, "");
    if (valor === "") {
      e.target.textContent = "";
    } else {
      valor = (parseFloat(valor) / 100).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
      e.target.textContent = valor;
    }
  }
  salvarDados();
});

// ========== SOMAT√ìRIO ==========
function atualizarRodape() {
  const colunas = thead.querySelectorAll("th");
  while (tfoot.children.length < colunas.length) {
    tfoot.appendChild(document.createElement("td"));
  }
  for (let i = 2; i < colunas.length; i++) {
    const th = colunas[i];
    const td = tfoot.children[i];
    if (th.classList.contains("coluna-moeda")) {
      let soma = 0;
      tabela.querySelectorAll("tr").forEach(tr => {
        const texto = tr.children[i].textContent.replace(/[R$\s.]/g, "").replace(",", ".");
        const num = parseFloat(texto);
        if (!isNaN(num)) soma += num;
      });
      td.textContent = soma.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    } else {
      td.textContent = "";
    }
  }
}

// ========== PDF ==========
salvarPDFBtn.onclick = async () => {
  const { jsPDF } = window.jspdf;
  const clone = document.getElementById("tabela").cloneNode(true);
  const temp = document.createElement("div");
  temp.style.position = "fixed";
  temp.style.left = "-9999px";
  temp.appendChild(clone);
  document.body.appendChild(temp);
  const canvas = await html2canvas(clone, { scale: 2 });
  document.body.removeChild(temp);
  const imgData = canvas.toDataURL("image/png");

  const pdf = new jsPDF("portrait", "pt", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth() - 80;
  const pageHeight = pdf.internal.pageSize.getHeight() - 100;
  const scale = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
  const x = 40, y = 60;
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text("Relat√≥rio de Dados por Data", pdf.internal.pageSize.getWidth() / 2, 40, { align: "center" });
  pdf.addImage(imgData, "PNG", x, y, canvas.width * scale, canvas.height * scale);
  pdf.save("tabela_dados.pdf");
};

// ========== LIMPAR DADOS ==========
limparDadosBtn.onclick = () => {
  if (confirm("Deseja realmente apagar todos os dados salvos?")) {
    localStorage.clear();
    location.reload();
  }
};

// ========== EVENTOS ==========
gerarBtn.onclick = () => {
  if (!inputMes.value) return alert("Selecione um m√™s!");
  gerarTabela(inputMes.value);
  salvarEstrutura();
  salvarDados();
};

// Ao carregar a p√°gina
restaurarTudo();
</script>

</body>
</html>
